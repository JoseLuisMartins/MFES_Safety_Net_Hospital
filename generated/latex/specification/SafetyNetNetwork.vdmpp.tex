\begin{vdmpp}[breaklines=true]
class SafetyNetNetwork 
instance variables
  private hospitals: inmap nat to Hospital := { |-> };
  private doctors: inmap nat to Doctor := { |-> };
  private patients: inmap nat to Patient := { |-> };
  private appointments: set of Appointment := {};
  private static networkInstance: SafetyNetNetwork := new SafetyNetNetwork();
  
  inv not exists h1, h2 in set rng hospitals &
  h1 <> h2 and h1.getName() = h2.getName();

operations

  --constructor
(*@
\label{SafetyNetNetwork:15}
@*)
  private SafetyNetNetwork: () ==> SafetyNetNetwork
  SafetyNetNetwork() == return self
  post hospitals = { |-> } and  doctors = { |-> };

  --get network instance
(*@
\label{getInstance:20}
@*)
  public pure static getInstance: () ==> SafetyNetNetwork
  getInstance() == return networkInstance
  post isofclass(SafetyNetNetwork,RESULT);

  
  --clear network instance
(*@
\label{clearInstance:26}
@*)
  public static clearInstance: () ==> ()
  clearInstance() == (
   networkInstance := new SafetyNetNetwork(); 
  );
  
  --associate doctor to hospital
(*@
\label{associateDoctorToHospital:32}
@*)
  public associateDoctorToHospital : nat * nat ==> ()
   associateDoctorToHospital(hospitalId, doctorId) == (
    hospitals(hospitalId).addDoctor(doctorId)
  )
  pre hospitalId in set dom hospitals and doctorId in set dom doctors and doctorId not in set hospitals(hospitalId).getDoctorsIds()
   post hospitalId in set dom hospitals and doctorId in set dom doctors and doctorId in set hospitals(hospitalId).getDoctorsIds();
    
  
  --disassociate doctor from hospital
(*@
\label{disassociateDoctorFromHospital:41}
@*)
  public disassociateDoctorFromHospital : nat * nat ==> ()
   disassociateDoctorFromHospital(hospitalId, doctorId) == (
    hospitals(hospitalId).removeDoctor(doctorId)
  )
  pre hospitalId in set dom hospitals and doctorId in set dom doctors and doctorId in set hospitals(hospitalId).getDoctorsIds()
  post hospitalId in set dom hospitals and doctorId in set dom doctors and doctorId not in set hospitals(hospitalId).getDoctorsIds();
    
  -----------------------------------------------------------
  ------------------Hospital---------------------------------
  -----------------------------------------------------------
   -- get hospitals
(*@
\label{getHospitals:52}
@*)
  public pure getHospitals : () ==> inmap nat to Hospital
  getHospitals() == (
   return hospitals;
  );
    
  
   --add hospital
(*@
\label{addHospital:59}
@*)
  public addHospital: Hospital ==> ()
  addHospital(hospital) == (
   hospitals := hospitals ++  { hospital.getId() |-> hospital};
  )
  pre {hospital.getId() } <: hospitals = { |-> } 
  post {hospital.getId() } <: hospitals = { hospital.getId() |-> hospital } ;
  
  --remove an hospital
(*@
\label{removeHospital:67}
@*)
  public removeHospital: Hospital ==> ()
  removeHospital(hospital) == (   
   hospitals := {hospital.getId()} <-: hospitals;
   --cancel appointments in that hospital
   for all a in set appointments do 
    if(a.getHospitalId() = hospital.getId()) then
     removeAppointment(a);
  )
   pre {hospital.getId()} <: hospitals = { hospital.getId() |-> hospital } 
  post {hospital.getId()} <: hospitals = { |-> } and 
     forall a in set appointments & a.getHospitalId() <> hospital.getId();
  
  -- add agreement to hospital
(*@
\label{addAgreementToHospital:80}
@*)
  public addAgreementToHospital: nat * ModelUtils`Agreement ==> ()
  addAgreementToHospital(hospitalId, agreement) == (
   hospitals(hospitalId).addAgreement(agreement);
  )
  pre {hospitalId} <: hospitals = { hospitalId |-> hospitals(hospitalId) };
  

  -- remove agreement from hospital
(*@
\label{removeAgreementFromHospital:88}
@*)
  public removeAgreementFromHospital: nat * ModelUtils`Agreement ==> ()
  removeAgreementFromHospital(hospitalId, agreement) == (
   hospitals(hospitalId).removeAgreement(agreement);
  )
  pre {hospitalId} <: hospitals = { hospitalId |-> hospitals(hospitalId) };
  
  -------search hospitals------------------------------------
 
  ----------get hospitals by id
(*@
\label{getHospitalsById:97}
@*)
  public pure getHospitalsById: nat ==> Hospital
   getHospitalsById(hospitalId) == (
    return hospitals(hospitalId);
   )
  pre hospitalId in set dom hospitals
  post RESULT.getId() = hospitalId;
   
  ----------get hospitals by city
(*@
\label{getHospitalsByCity:105}
@*)
  public pure getHospitalsByCity: ModelUtils`String ==> set of Hospital
   getHospitalsByCity(city) == (
    dcl res : set of Hospital := {};
    for all h in set rng hospitals do
      if(h.getLocation().city = city) then
       res := res union {h};
    return res
   );
  
  ----------get hospitals by name
(*@
\label{getHospitalsByName:115}
@*)
  public pure getHospitalsByName: ModelUtils`String ==> set of Hospital
   getHospitalsByName(name) == (
    dcl res : set of Hospital := {};
    for all h in set rng hospitals do
      if(h.getName() = name) then
       res := res union {h};
    return res
   );
  
  ----------get hospitals by agreement
(*@
\label{getHospitalsByAgreement:125}
@*)
  public pure getHospitalsByAgreement: ModelUtils`Agreement ==> set of Hospital
   getHospitalsByAgreement(agreement) == (
    dcl res : set of Hospital := {};
    for all h in set rng hospitals do
      if(agreement in set h.getAgreements()) then
       res := res union {h};
    return res
   );
   
  ----------get hospitals by specialty
(*@
\label{getHospitalsBySpecialty:135}
@*)
  public pure getHospitalsBySpecialty: ModelUtils`Specialty ==> set of Hospital
   getHospitalsBySpecialty(specialty) == (
    dcl res : set of Hospital := {};
    for all h in set rng hospitals do
     for all d in set h.getDoctorsIds() do
      if(specialty = doctors(d).getSpecialty()) then
       res := res union {h};
    return res
   );
   
  -------------------End hospital search--------------------------------
    
  -- get hospitals specialties
(*@
\label{getHospitalSpecialties:148}
@*)
  public pure getHospitalSpecialties: nat ==> set of ModelUtils`Specialty
   getHospitalSpecialties(hospitalId) == (
    dcl res : set of ModelUtils`Specialty := {};
     for all doctorId in set hospitals(hospitalId).getDoctorsIds() do
       res := res union {doctors(doctorId).getSpecialty()};
    return res
   );
   
    
  ---------------------------------------------------------------
  -----------------------end hospital ---------------------------
  ---------------------------------------------------------------
  
  
  ---------------------------------------------------------
  -----------------------Doctors --------------------------
  ---------------------------------------------------------
  -- get doctors
(*@
\label{getDoctors:166}
@*)
  public pure getDoctors : () ==> inmap nat to Doctor
  getDoctors() == (
   return doctors;
  );
    
  --add doctor
(*@
\label{addDoctor:172}
@*)
  public addDoctor: Doctor ==> ()
  addDoctor(doctor) == (
   doctors := doctors ++  { doctor.getId() |-> doctor};
  )
  pre {doctor.getId() } <: doctors = { |-> }  
  post {doctor.getId() } <: doctors = { doctor.getId() |-> doctor };
  
  --remove doctor from the network and from all the hospitals where he works
(*@
\label{removeDoctor:180}
@*)
  public removeDoctor: Doctor ==> ()
  removeDoctor(doctor) == (
   --remove doctor from network
   doctors := {doctor.getId()} <-: doctors;
   --remove doctor from hospitals where he works
   for all h in set rng hospitals do 
    if(doctor.getId() in set h.getDoctorsIds()) then
     h.removeDoctor(doctor.getId());
   --cancel doctor appointments
   for all a in set appointments do 
    if(a.getDoctorId() = doctor.getId()) then
     removeAppointment(a);
  )
   pre {doctor.getId()} <: doctors = { doctor.getId() |-> doctor } 
  post {doctor.getId()} <: doctors = { |-> } and 
     forall h in set rng hospitals & doctor.getId() not in set h.getDoctorsIds() and 
     forall a in set appointments & a.getDoctorId() <> doctor.getId();
  
  
  --search doctors--------------------------------
  ----------get doctor by specialty
(*@
\label{getDoctorsBySpecialty:201}
@*)
  public pure getDoctorsBySpecialty: ModelUtils`Specialty ==> set of Doctor
   getDoctorsBySpecialty(s) == (
    dcl res : set of Doctor := {};
    for all d in set rng doctors do
      if(d.getSpecialty() = s) then
       res := res union {d};
    return res
   );
  
  ----------get doctor by id
(*@
\label{getDoctorById:211}
@*)
  public pure getDoctorById: nat ==> Doctor
   getDoctorById(doctorId) == (
    return doctors(doctorId);
   )
  pre doctorId in set dom doctors
  post RESULT.getId() = doctorId;
   
  ----------get hospitals where a doctor works
(*@
\label{getDoctorHospitals:219}
@*)
  public pure getDoctorHospitals: nat ==> set of Hospital
   getDoctorHospitals(doctorId) == (
    dcl res : set of Hospital := {};
    for all h in set rng hospitals do
     if(doctorId in set h.getDoctorsIds()) then
      res := res union {h};
    return res
   );
   
  ---------------------------------------------------------
  -----------------------End Doctors ----------------------
  ---------------------------------------------------------
  
  
  -----------------------------------------------------------
  ------------------Patients---------------------------------
  -----------------------------------------------------------
  
  --add patient
(*@
\label{addPatient:238}
@*)
  public addPatient: Patient ==> ()
  addPatient(patient) == (
   patients := patients ++  { patient.getId() |-> patient};
  )
  pre {patient.getId() } <: patients = { |-> }  
  post {patient.getId() } <: patients = { patient.getId() |-> patient };
  
  --remove patient
(*@
\label{removePatient:246}
@*)
  public removePatient: Patient ==> ()
  removePatient(patient) == (
   --remove patient appointments
   for all a in set appointments do 
    if(a.getPatientId() = patient.getId()) then
     removeAppointment(a);
   --remove patient from network
   patients := {patient.getId()} <-: patients;
  )
   pre {patient.getId()} <: patients = { patient.getId() |-> patient } 
  post {patient.getId()} <: patients = { |-> } and forall a in set appointments & a.getPatientId() <> patient.getId();
   
  --add clinical observation
(*@
\label{addClinicalObservation:259}
@*)
  public addClinicalObservation: nat * ModelUtils`String ==> ()
  addClinicalObservation(patientId, obs) == (
   patients(patientId).addObservation(obs);
  )
   pre {patientId} <: patients = { patientId |-> patients(patientId) } ;
   
   -- get patients
(*@
\label{getPatients:266}
@*)
  public pure getPatients : () ==> inmap nat to Patient
  getPatients() == (
   return patients;
  );
  
  ----------get patient by id
(*@
\label{getPatientById:272}
@*)
  public pure getPatientById: nat ==> Patient
   getPatientById(patientId) == (
    return patients(patientId);
   )
  pre patientId in set dom patients
  post RESULT.getId() = patientId;
  
  
  ---------------------------------------------------------
  ------------------End Patients-----------------------------
  -----------------------------------------------------------

  ---------------------------------------------------------
  ----------------------Appointments-----------------------
  ---------------------------------------------------------
  
  -- get appointments
(*@
\label{getAppointments:289}
@*)
  public pure getAppointments : () ==> set of Appointment
  getAppointments() == (
   return appointments;
  );
  
  --get hospital appointments
(*@
\label{getHospitalAppointments:295}
@*)
  public pure getHospitalAppointments: nat ==> set of Appointment
  getHospitalAppointments(hospitalId) == (
   dcl res: set of Appointment := {};
   for all a in set appointments do 
    if(a.getHospitalId() = hospitalId) then
      res := res union {a}; 
  
   return res
  )
  pre {hospitalId} <: hospitals = { hospitalId |-> hospitals(hospitalId) }
  post forall a in set RESULT & isofclass(Appointment,a) and a.getHospitalId() = hospitalId;

  -- total number of appointments in a hospital
(*@
\label{getHospitalNumberOfAppointments:308}
@*)
  public pure getHospitalNumberOfAppointments: nat ==> nat
   getHospitalNumberOfAppointments(hospitalId) == (
    return card getHospitalAppointments(hospitalId);
  )
  pre hospitalId in set dom hospitals;
   
  
  
  --get doctor appointments
(*@
\label{getDoctorAppointments:317}
@*)
  public pure getDoctorAppointments: nat ==> set of Appointment
  getDoctorAppointments(doctorId) == (
   dcl res: set of Appointment := {};
   for all a in set appointments do 
    if(a.getDoctorId() = doctorId) then
      res := res union {a}; 
   return res
  )
  pre {doctorId} <: doctors = { doctorId |-> doctors(doctorId) }
  post forall a in set RESULT & isofclass(Appointment,a) and a.getDoctorId() = doctorId;
  
  --get patient appointments
(*@
\label{getPatientAppointments:329}
@*)
  public pure getPatientAppointments: nat ==> set of Appointment
  getPatientAppointments(patientId) == (
   dcl res: set of Appointment := {};
   for all a in set appointments do 
    if(a.getPatientId() = patientId) then
      res := res union {a}; 
   return res
  )
  pre {patientId} <: patients = { patientId |-> patients(patientId) }
  post forall a in set RESULT & isofclass(Appointment,a) and a.getPatientId() = patientId;
  
  --get specialty appointments
(*@
\label{getSpecialtyAppointments:341}
@*)
  public pure getSpecialtyAppointments: ModelUtils`Specialty ==> set of Appointment
  getSpecialtyAppointments(specialty) == (
   dcl res: set of Appointment := {};
   for all a in set appointments do 
    if(doctors(a.getDoctorId()).getSpecialty() = specialty) then
      res := res union {a}; 
   return res
  )
  post forall a in set RESULT & isofclass(Appointment,a) and doctors(a.getDoctorId()).getSpecialty() = specialty;
  
  
  --add an Appointment
(*@
\label{addAppointment:353}
@*)
  public addAppointment: Appointment ==> ()
  addAppointment(a) == (
   appointments := appointments union {a}; 
  )
  pre forall ap in set getDoctorAppointments(a.getDoctorId()) union getPatientAppointments(a.getPatientId()) & Appointment`appointmentDatesDontOverlap(ap.getDate(), a.getDate())
  post a in set appointments;
  
  --remove an Appointment
(*@
\label{removeAppointment:361}
@*)
  public removeAppointment: Appointment ==> ()
  removeAppointment(a) == (
   appointments := appointments \ {a}; 
  )
  pre a in set appointments
  post a not in set appointments;
  
  
  
  -- get closest appointment date available given a set of doctors
  -- example: pass the doctor ids with who you want to get an appointment and receive the closest appointment date and the doctor available on that date
(*@
\label{getHospitalClosestAvailableDate:372}
@*)
(*@
\label{getClosestAvailableDate:372}
@*)
  public getClosestAvailableDate: set of nat ==> ModelUtils`Date_DoctorId   
   getClosestAvailableDate(availableDoctors) == (
   dcl minDate: ModelUtils`Date := ModelUtils`getMaxDate(); 
   dcl doctorId: nat;
   
   for all docId in set availableDoctors do
   (
    dcl auxDate : ModelUtils`Date := getDoctorFirstAvailableDate(docId);
    if(ModelUtils`isDateLower(auxDate, minDate)) then
       (
        doctorId := docId;
        minDate := auxDate;
       )
   );
   
   return mk_ModelUtils`Date_DoctorId(minDate, doctorId);
  )
  pre forall d in set availableDoctors & d in set dom doctors
  post RESULT.doctorId in set dom doctors;
  
  -- get the doctor first available date
(*@
\label{getDoctorFirstAvailableDate:393}
@*)
  public getDoctorFirstAvailableDate: nat ==> ModelUtils`Date   
   getDoctorFirstAvailableDate(docId) == (
   dcl minDate: ModelUtils`Date := ModelUtils`getMaxDate(); 
   dcl occupiedDates: set of ModelUtils`Date := {};
   
  
   for all docAp in set getDoctorAppointments(docId) do
    occupiedDates := occupiedDates union {docAp.getDate()};
   
   
   -- have to check if the first date is available
   occupiedDates := occupiedDates union {ModelUtils`getMinDate()};
   
   for all date in set occupiedDates do
   (
    dcl auxDate : ModelUtils`Date := Appointment`getNextAppointmentDate(date);
    if(ModelUtils`isDateLower(auxDate, minDate)) then  
       if(forall docAp in set getDoctorAppointments(docId) &  Appointment`appointmentDatesDontOverlap(docAp.getDate(),auxDate)) then -- if the next appointment is on a closer date than the actual minimum and one of the doctor has the date slot available, update the minimum
        minDate := auxDate;
       
   );
   
   return minDate;
  )
  pre docId in set dom doctors;
 
  
  
   ---------------------------------------------------------
  ----------------------End Appointments-------------------
  ---------------------------------------------------------
  

end SafetyNetNetwork
\end{vdmpp}
\bigskip
\begin{longtable}{|l|r|r|r|}
\hline
Function or operation & Line & Coverage & Calls \\
\hline
\hline
\hyperref[SafetyNetNetwork:15]{SafetyNetNetwork} & 15&100.0\% & 606 \\
\hline
\hyperref[addAgreementToHospital:80]{addAgreementToHospital} & 80&100.0\% & 13 \\
\hline
\hyperref[addAppointment:353]{addAppointment} & 353&100.0\% & 448 \\
\hline
\hyperref[addClinicalObservation:259]{addClinicalObservation} & 259&100.0\% & 48 \\
\hline
\hyperref[addDoctor:172]{addDoctor} & 172&100.0\% & 852 \\
\hline
\hyperref[addHospital:59]{addHospital} & 59&100.0\% & 971 \\
\hline
\hyperref[addPatient:238]{addPatient} & 238&100.0\% & 364 \\
\hline
\hyperref[associateDoctorToHospital:32]{associateDoctorToHospital} & 32&100.0\% & 694 \\
\hline
\hyperref[clearInstance:26]{clearInstance} & 26&100.0\% & 581 \\
\hline
\hyperref[disassociateDoctorFromHospital:41]{disassociateDoctorFromHospital} & 41&100.0\% & 25 \\
\hline
\hyperref[getAppointments:289]{getAppointments} & 289&100.0\% & 240 \\
\hline
\hyperref[getClosestAvailableDate:372]{getClosestAvailableDate} & 372&100.0\% & 38 \\
\hline
\hyperref[getDoctorAppointments:317]{getDoctorAppointments} & 317&100.0\% & 920 \\
\hline
\hyperref[getDoctorById:211]{getDoctorById} & 211&100.0\% & 72 \\
\hline
\hyperref[getDoctorFirstAvailableDate:393]{getDoctorFirstAvailableDate} & 393&100.0\% & 19 \\
\hline
\hyperref[getDoctorHospitals:219]{getDoctorHospitals} & 219&100.0\% & 72 \\
\hline
\hyperref[getDoctors:166]{getDoctors} & 166&100.0\% & 1499 \\
\hline
\hyperref[getDoctorsBySpecialty:201]{getDoctorsBySpecialty} & 201&100.0\% & 72 \\
\hline
\hyperref[getHospitalAppointments:295]{getHospitalAppointments} & 295&100.0\% & 120 \\
\hline
\hyperref[getHospitalClosestAvailableDate:372]{getHospitalClosestAvailableDate} & 372&100.0\% & 38 \\
\hline
\hyperref[getHospitalNumberOfAppointments:308]{getHospitalNumberOfAppointments} & 308&100.0\% & 192 \\
\hline
\hyperref[getHospitalSpecialties:148]{getHospitalSpecialties} & 148&100.0\% & 72 \\
\hline
\hyperref[getHospitals:52]{getHospitals} & 52&100.0\% & 1155 \\
\hline
\hyperref[getHospitalsByAgreement:125]{getHospitalsByAgreement} & 125&100.0\% & 150 \\
\hline
\hyperref[getHospitalsByCity:105]{getHospitalsByCity} & 105&100.0\% & 50 \\
\hline
\hyperref[getHospitalsById:97]{getHospitalsById} & 97&100.0\% & 75 \\
\hline
\hyperref[getHospitalsByName:115]{getHospitalsByName} & 115&100.0\% & 75 \\
\hline
\hyperref[getHospitalsBySpecialty:135]{getHospitalsBySpecialty} & 135&100.0\% & 99 \\
\hline
\hyperref[getInstance:20]{getInstance} & 20&100.0\% & 5758 \\
\hline
\hyperref[getPatientAppointments:329]{getPatientAppointments} & 329&100.0\% & 640 \\
\hline
\hyperref[getPatientById:272]{getPatientById} & 272&100.0\% & 4 \\
\hline
\hyperref[getPatients:266]{getPatients} & 266&100.0\% & 400 \\
\hline
\hyperref[getSpecialtyAppointments:341]{getSpecialtyAppointments} & 341&100.0\% & 72 \\
\hline
\hyperref[removeAgreementFromHospital:88]{removeAgreementFromHospital} & 88&100.0\% & 13 \\
\hline
\hyperref[removeAppointment:361]{removeAppointment} & 361&100.0\% & 192 \\
\hline
\hyperref[removeDoctor:180]{removeDoctor} & 180&100.0\% & 48 \\
\hline
\hyperref[removeHospital:67]{removeHospital} & 67&100.0\% & 72 \\
\hline
\hyperref[removePatient:246]{removePatient} & 246&100.0\% & 48 \\
\hline
\hline
SafetyNetNetwork.vdmpp & & 100.0\% & 16807 \\
\hline
\end{longtable}

